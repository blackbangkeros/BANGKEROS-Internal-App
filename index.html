import React, { useState, useMemo } from 'react';
import { LoaderCircle, FileText, FileSignature, FolderKanban, Sparkles, Copy, Check, PenSquare } from 'lucide-react';

// Main App Component
export default function App() {
    // --- State Management ---
    const [docType, setDocType] = useState('Policy');
    const [userInput, setUserInput] = useState('');
    const [generatedDoc, setGeneratedDoc] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [isWhereasLoading, setIsWhereasLoading] = useState(false);
    const [error, setError] = useState('');
    const [isCopied, setIsCopied] = useState(false);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [whereasInput, setWhereasInput] = useState('');
    const [generatedWhereas, setGeneratedWhereas] = useState('');


    // --- Document Type Configuration ---
    const docTypes = [
        { name: 'Policy', icon: <FileText /> },
        { name: 'Resolution', icon: <FileSignature /> },
        { name: 'Project', icon: <FolderKanban /> },
    ];

    const placeholderText = useMemo(() => {
        switch (docType) {
            case 'Policy':
                return "e.g., A policy requiring first-aid kits on all tour boats.";
            case 'Resolution':
                return "e.g., A resolution to formally adopt the 'Luntian' mascot.";
            case 'Project':
                return "e.g., A project to install new Luntian-branded mooring buoys.";
            default:
                return "Enter your idea...";
        }
    }, [docType]);

    // --- Gemini API Call Handler ---
    const callGeminiAPI = async (prompt) => {
        try {
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            const result = await response.json();
            
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("The AI could not generate a response. Please try rephrasing.");
            }
        } catch (err) {
            console.error("Gemini API call failed:", err);
            throw new Error("There was an error connecting to the AI assistant. Please try again.");
        }
    };

    const handleGenerate = async () => {
        if (!userInput.trim()) {
            setError('Please enter your idea or objective.');
            return;
        }

        setIsLoading(true);
        setError('');
        setGeneratedDoc('');
        
        let prompt = `You are an expert in Philippine cooperative governance and law (RA 9520), serving as a virtual administrative assistant for the BANGKEROS Cooperative in Port Barton, Palawan. You are deeply familiar with all BANGKEROS policies, including their Master Formulation and Documentation Policy (GOV-POL-002), their 9 Pillars of Development, their Luntian principles, and their specific document coding system. Your task is to generate a formal, well-structured document based on the user's request. Always use the official BANGKEROS header.

User's Request: "${userInput}"

Generate the following document type: **${docType}**

`;

        switch (docType) {
            case 'Policy':
                prompt += `Structure the document as a formal cooperative policy. It must include the standard articles: Rationale and Purpose, Scope and Application, specific Policy Statements, Responsibilities, and Effectivity. Assign it an appropriate document code based on its likely category (e.g., OPS-POL-003).`;
                break;
            case 'Resolution':
                prompt += `Structure the document as a formal cooperative board resolution. It must be presented as an "Excerpt from the Minutes" and include 'WHEREAS' clauses providing justification, and a 'NOW, THEREFORE, BE IT RESOLVED' clause stating the decision. Use the official BANGKEROS header and assign a resolution number (e.g., RES-2025-07101).`;
                break;
            case 'Project':
                prompt += `Structure the document as a formal project proposal. The proposal must include the following sections: Rationale, Project Objectives, Project Description, Implementation Plan, and Budgetary Requirements. Frame it within the context of the BANGKEROS 9 Pillars of Development. Assign it a document code (e.g., PRJ-2025-004).`;
                break;
        }
        
        try {
            const result = await callGeminiAPI(prompt);
            setGeneratedDoc(result);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    const handleGenerateWhereas = async () => {
        if (!whereasInput.trim()) return;

        setIsWhereasLoading(true);
        setGeneratedWhereas('');
        
        const prompt = `You are an expert in Philippine cooperative governance. A user needs to write the justification (the 'WHEREAS' clauses) for a board resolution. The main decision of the resolution is: "${whereasInput}".

Generate 3-4 distinct and logical 'WHEREAS' clauses that build a strong foundation for this decision. Each clause should start with "WHEREAS," and provide a clear reason, background, or legal basis. The tone should be formal and professional. Present them as a list.`;

        try {
            const result = await callGeminiAPI(prompt);
            setGeneratedWhereas(result);
        } catch (err) {
            setGeneratedWhereas(`Error: ${err.message}`);
        } finally {
            setIsWhereasLoading(false);
        }
    };
    
    const handleCopy = (textToCopy) => {
        if (!textToCopy) return;
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = textToCopy;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextarea);
        
        setIsCopied(true);
        setTimeout(() => setIsCopied(false), 2000);
    };

    return (
        <>
            <div className="bg-slate-100 min-h-screen font-sans p-4 sm:p-6 md:p-8">
                <div className="max-w-7xl mx-auto">
                    <header className="text-center mb-10">
                        <img src="https://raw.githubusercontent.com/js-fan/logo-hosting/main/bangkeros_seal.png" alt="BANGKEROS Logo" className="mx-auto mb-4 h-24 w-24" onError={e => e.target.style.display='none'}/>
                        <h1 className="text-4xl sm:text-5xl font-extrabold text-slate-800 tracking-tight">BANGKEROS Document Generator</h1>
                        <p className="text-lg text-slate-600 mt-2">Your AI-powered assistant for cooperative governance.</p>
                    </header>

                    <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                        <div className="mb-6">
                            <label className="block text-lg font-bold text-slate-700 mb-3">Step 1: Choose a document type</label>
                            <div className="flex flex-wrap gap-3">
                                {docTypes.map(type => (
                                    <button
                                        key={type.name}
                                        onClick={() => setDocType(type.name)}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all duration-200 border-2 ${docType === type.name ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 border-slate-300 hover:border-blue-500 hover:text-blue-600'}`}
                                    >
                                        {type.icon}
                                        {type.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="mb-6">
                            <label htmlFor="userInput" className="block text-lg font-bold text-slate-700 mb-3">Step 2: Describe what you need</label>
                            <textarea
                                id="userInput"
                                rows="3"
                                value={userInput}
                                onChange={(e) => setUserInput(e.target.value)}
                                className="w-full p-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder={placeholderText}
                            />
                        </div>
                        
                        <div className="flex flex-col sm:flex-row gap-3">
                             <button
                                onClick={handleGenerate}
                                disabled={isLoading}
                                className="w-full flex-grow flex items-center justify-center gap-3 bg-blue-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl disabled:bg-slate-400 disabled:cursor-not-allowed"
                            >
                                {isLoading ? (<><LoaderCircle className="animate-spin" /><span>Generating...</span></>) : (<><Sparkles /><span>Generate Full Document</span></>)}
                            </button>

                             {docType === 'Resolution' && (
                                <button
                                    onClick={() => setIsModalOpen(true)}
                                    className="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-100 text-indigo-700 font-bold py-4 px-6 rounded-lg hover:bg-indigo-200 transition-colors border-2 border-indigo-200"
                                >
                                    <PenSquare />
                                    <span>✨ WHEREAS Assistant</span>
                                </button>
                             )}
                        </div>
                         {error && <p className="text-red-600 mt-3 text-sm text-center">{error}</p>}
                    </div>

                    <div className="mt-10">
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">Generated Document Draft</h2>
                         <div className="relative">
                            <pre className="bg-white p-6 rounded-lg border border-slate-200 shadow-inner whitespace-pre-wrap font-sans text-sm min-h-[200px] text-slate-800">
                               {generatedDoc || "Your AI-generated document will appear here..."}
                            </pre>
                            {generatedDoc && (
                                 <button 
                                    onClick={() => handleCopy(generatedDoc)}
                                    className="absolute top-3 right-3 bg-slate-200 hover:bg-slate-300 text-slate-700 p-2 rounded-md"
                                    title="Copy to Clipboard"
                                >
                                    {isCopied ? <Check className="text-green-600" size={18}/> : <Copy size={18} />}
                                </button>
                            )}
                         </div>
                          <p className="text-xs text-slate-500 mt-2 text-center">Note: This is an AI-generated draft. Please review and finalize with the Board of Directors before adoption.</p>
                    </div>
                </div>
            </div>

            {isModalOpen && (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-indigo-800 flex items-center gap-2"><PenSquare /> ✨ WHEREAS Clause Assistant</h3>
                            <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600">&times;</button>
                        </div>
                        <p className="text-slate-600 mb-4">Enter the main point of your resolution (the "Resolved" part) to get help writing the justification.</p>
                        
                        <div>
                            <label htmlFor="whereas-input" className="font-semibold text-slate-700">Main decision of the resolution:</label>
                            <textarea 
                                id="whereas-input" 
                                rows="2"
                                value={whereasInput}
                                onChange={e => setWhereasInput(e.target.value)}
                                className="w-full mt-2 p-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="e.g., to approve the purchase of a new service vehicle"
                            ></textarea>
                            <button 
                                onClick={handleGenerateWhereas}
                                disabled={isWhereasLoading}
                                className="w-full mt-4 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-slate-400"
                            >
                                {isWhereasLoading ? <LoaderCircle className="animate-spin mx-auto"/> : "Generate Justifications"}
                            </button>
                        </div>

                        {generatedWhereas && (
                            <div className="mt-6">
                                <hr className="my-4"/>
                                <h4 className="font-semibold text-slate-700">AI-Generated Suggestions:</h4>
                                <div className="relative mt-2 p-4 bg-slate-100 rounded-lg border text-slate-800 text-sm">
                                    <pre className="whitespace-pre-wrap font-sans">{generatedWhereas}</pre>
                                     <button 
                                        onClick={() => handleCopy(generatedWhereas)}
                                        className="absolute top-2 right-2 bg-slate-200 hover:bg-slate-300 text-slate-700 p-2 rounded-md"
                                        title="Copy to Clipboard"
                                    >
                                        {isCopied ? <Check className="text-green-600" size={16}/> : <Copy size={16} />}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                 </div>
            )}
        </>
    );
}
